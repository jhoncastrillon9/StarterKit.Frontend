<!-- Floating chat button -->
<div class="chatbot-fab" *ngIf="!isOpen" (click)="toggleChat()" [@fabAnimation]>
  <div class="fab-icon">
    <i class="pi pi-comments"></i>
  </div>
  <div class="fab-pulse"></div>
</div>

<!-- Chat window -->
<div class="chatbot-window"
     *ngIf="isOpen"
     [class.mobile]="isMobile"
     [@chatWindowAnimation]>

  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <div class="bot-avatar">
        <i class="pi pi-android"></i>
        <span class="status-indicator"
              [class.online]="connectionStatus === 'connected'"
              [class.offline]="connectionStatus === 'disconnected'"
              [class.connecting]="connectionStatus === 'connecting' || connectionStatus === 'reconnecting'">
        </span>
      </div>
      <div class="header-info">
        <span class="bot-name">Asistente Virtual</span>
        <span class="bot-status" *ngIf="connectionStatus === 'connected' && !isBotTyping">En linea</span>
        <span class="bot-status typing" *ngIf="connectionStatus === 'connected' && isBotTyping">Escribiendo...</span>
        <span class="bot-status connecting" *ngIf="connectionStatus === 'connecting'">Conectando...</span>
        <span class="bot-status reconnecting" *ngIf="connectionStatus === 'reconnecting'">Reconectando...</span>
        <span class="bot-status disconnected" *ngIf="connectionStatus === 'disconnected'">Desconectado</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="header-btn" (click)="openConfirmationModal()" title="Borrar conversacion">
        <i class="pi pi-trash"></i>
      </button>
      <button class="header-btn minimize-btn" (click)="toggleChat()" title="Minimizar">
        <i class="pi pi-minus"></i>
      </button>
      <button class="header-btn close-btn" (click)="closeChat()" title="Cerrar">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>

  <!-- Connection banner -->
  <div class="connection-banner" *ngIf="connectionStatus === 'disconnected' || connectionStatus === 'reconnecting'">
    <span *ngIf="connectionStatus === 'reconnecting'">
      <i class="pi pi-spin pi-spinner"></i> Reconectando...
    </span>
    <span *ngIf="connectionStatus === 'disconnected'">
      <i class="pi pi-exclamation-circle"></i> Sin conexion
      <button class="reconnect-btn" (click)="manualReconnect()">Reintentar</button>
    </span>
  </div>

  <!-- Messages area -->
  <div class="chat-messages" #messagesContainer>
    <!-- Empty state -->
    <div *ngIf="messages.length === 0 && !isBotTyping" class="empty-state">
      <div class="empty-icon">
        <i class="pi pi-comments"></i>
      </div>
      <h4>Hola, bienvenido</h4>
      <p>Soy tu asistente virtual. Â¿En que puedo ayudarte hoy?</p>
    </div>

    <!-- Chat messages -->
    <div *ngFor="let msg of messages; let i = index"
         class="message-wrapper"
         [class.user]="msg.sender === 'user'"
         [class.bot]="msg.sender === 'bot' || msg.sender === 'assistant'">

      <!-- Bot avatar for bot messages -->
      <div class="message-avatar" *ngIf="msg.sender === 'bot' || msg.sender === 'assistant'">
        <i class="pi pi-android"></i>
      </div>

      <div class="message-content">
        <!-- File download message -->
        <ng-container *ngIf="msg.fileResponse">
          <!-- Intro message bubble -->
          <div class="message-bubble bot-bubble" *ngIf="msg.fileResponse.message">
            <p class="message-text">{{ msg.fileResponse.message }}</p>
          </div>

          <!-- File download card -->
          <div class="file-download-card">
            <div class="file-icon">
              <i [class]="getFileIcon(msg.fileResponse.mimeType)"></i>
            </div>
            <div class="file-info">
              <span class="file-name">{{ msg.fileResponse.fileName }}</span>
              <span class="file-badge" *ngIf="msg.fileResponse.internalCode">
                Cotizacion #{{ msg.fileResponse.internalCode }}
              </span>
            </div>
            <button class="download-btn" (click)="downloadFile(msg.fileResponse)">
              <i class="pi pi-download"></i>
              Descargar
            </button>
          </div>

          <!-- Additional text after the download link -->
          <div class="message-bubble bot-bubble" *ngIf="msg.content">
            <p class="message-text">{{ msg.content }}</p>
            <span class="message-time" *ngIf="msg.timestamp">
              {{ formatTime(msg.timestamp) }}
            </span>
          </div>
        </ng-container>

        <!-- Regular message bubble (no file) -->
        <div class="message-bubble"
             *ngIf="!msg.fileResponse"
             [class.user-bubble]="msg.sender === 'user'"
             [class.bot-bubble]="msg.sender === 'bot' || msg.sender === 'assistant'">
          <p class="message-text">{{ msg.content }}</p>
          <span class="message-time" *ngIf="msg.timestamp">
            {{ formatTime(msg.timestamp) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Typing indicator -->
    <div *ngIf="isBotTyping" class="message-wrapper bot">
      <div class="message-avatar">
        <i class="pi pi-android"></i>
      </div>
      <div class="message-content">
        <div class="typing-indicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Input area -->
  <div class="chat-input-area">
    <div class="input-wrapper">
      <input
        type="text"
        [(ngModel)]="message"
        (keyup.enter)="sendMessage()"
        placeholder="Escribe un mensaje..."
        [disabled]="isBotTyping"
        #messageInput />
      <button
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="!message.trim() || isBotTyping"
        [class.active]="message.trim()">
        <i class="pi pi-send"></i>
      </button>
    </div>
    <span class="powered-by">Powered by AI</span>
  </div>
</div>

<!-- Confirmation modal -->
<app-confirmation-modal
  #confirmationModal
  [title]="'Confirmar'"
  [messageModal]="confirmationMessage"
  [isConfirmation]="true"
  [titleButtonComfimationYes]="'Si, borrar'"
  (confirmAction)="onConfirmDelete()">
</app-confirmation-modal>
