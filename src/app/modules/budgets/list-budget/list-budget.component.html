<!-- Container Principal Moderno -->
<div class="budget-list-container">
  <!-- Header Principal Moderno -->
  <div class="budget-list-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">
          <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">Cotizaciones</h1>
          <p class="page-subtitle">Gestiona y administra tus cotizaciones</p>
        </div>
      </div>
      <div class="header-right">
        <div class="header-actions">
          <button 
            pButton 
            type="button" 
            class="btn-ai-recording"
            [ngClass]="{'recording': isRecording, 'idle': !isRecording}"
            (click)="toggleRecordingAI()"
            [pTooltip]="isRecording ? 'Toca para detener' : 'Crear cotizacion con IA'"
            tooltipPosition="bottom">
            <div class="btn-ai-content">
              <div class="mic-container" [class.pulse-animation]="isRecording">
                <i class="pi pi-microphone"></i>
              </div>
              <span class="btn-ai-text">{{ isRecording ? 'Grabando...' : 'Crear con IA' }}</span>
            </div>
            <div *ngIf="isRecording" class="recording-waves">
              <span class="wave"></span>
              <span class="wave"></span>
              <span class="wave"></span>
              <span class="wave"></span>
            </div>
          </button>
          <a [routerLink]="'/budgets/add'" class="btn-new-budget">
            <i class="fas fa-plus"></i>
            <span>Nueva Cotizacion</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="stats-row">
    <div class="stat-card stat-total">
      <div class="stat-icon">
        <i class="fas fa-file-alt"></i>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ budgets.length }}</span>
        <span class="stat-label">Total Cotizaciones</span>
      </div>
    </div>
    <div class="stat-card stat-approved">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ getCountByStatus('Aprobada') }}</span>
        <span class="stat-label">Aprobadas</span>
      </div>
    </div>
    <div class="stat-card stat-pending">
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ getCountByStatus('Cotizada') }}</span>
        <span class="stat-label">Cotizadas</span>
      </div>
    </div>
    <div class="stat-card stat-invoiced">
      <div class="stat-icon">
        <i class="fas fa-file-invoice"></i>
      </div>
      <div class="stat-info">
        <span class="stat-value">{{ getCountWithInvoice() }}</span>
        <span class="stat-label">Facturadas</span>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="budget-list-card">
    <!-- Table Container -->
    <p-table #dt 
      class="budget-table-modern" 
      styleClass="p-datatable-modern"        
      [value]="budgets" 
      [paginator]="true" 
      [rows]="20"         
      [filterDelay]="3" 
      [loading]="loading" 
      [rowHover]="true"
      sortField="date,budgetId" 
      [sortOrder]="-1"
      [rowsPerPageOptions]="[20, 40, 60, 100]"
      currentPageReportTemplate="{first} al {last} de {totalRecords} cotizaciones"
      [globalFilterFields]="['budgetId', 'internalCode', 'date', 'budgetName', 'customerDto.customerName', 'total', 'estado', 'externalInvoice']"
      [tableStyle]="{ 'min-width': '50rem' }">

      <!-- Caption / Search Bar -->
      <ng-template pTemplate="caption">
        <div class="table-header-modern">
          <div class="search-section">
            <div class="search-input-wrapper">
              <i class="fas fa-search search-icon"></i>
              <input 
                pInputText 
                type="text" 
                [(ngModel)]="searchValue" 
                (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                placeholder="Buscar por codigo, cliente, obra..." 
                class="search-input"/>
              <button 
                *ngIf="searchValue" 
                class="clear-search-btn" 
                (click)="searchValue = ''; dt.filterGlobal('', 'contains')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          <div class="table-actions">
            <button 
              class="btn-filter-action" 
              (click)="clear(dt)"
              pTooltip="Limpiar filtros"
              tooltipPosition="bottom">
              <i class="fas fa-filter-circle-xmark"></i>
              <span>Limpiar</span>
            </button>
          </div>
        </div>
      </ng-template>

      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr class="table-header-row">
          <th pSortableColumn="budgetId" class="th-code">
            <div class="th-content">
              <i class="fas fa-hashtag"></i>
              <span>Codigo</span>
              <p-sortIcon field="budgetId" />
            </div>
          </th>
          <th pSortableColumn="date" class="th-date">
            <div class="th-content">
              <i class="far fa-calendar-alt"></i>
              <span>Fecha</span>
              <p-sortIcon field="date" />
            </div>
          </th>
          <th pSortableColumn="budgetName" class="th-name">
            <div class="th-content">
              <i class="fas fa-building"></i>
              <span>Obra</span>
              <p-sortIcon field="budgetName" />
            </div>
          </th>
          <th pSortableColumn="customerDto.customerName" class="th-customer">
            <div class="th-content">
              <i class="fas fa-user-tie"></i>
              <span>Cliente</span>
              <p-sortIcon field="customerDto.customerName" />
            </div>
          </th>
          <th pSortableColumn="externalInvoice" class="th-invoice">
            <div class="th-content">
              <i class="fas fa-file-invoice"></i>
              <span>Factura</span>
              <p-sortIcon field="externalInvoice" />
            </div>
          </th>
          <th pSortableColumn="estado" class="th-status">
            <div class="th-content">
              <i class="fas fa-flag"></i>
              <span>Estado</span>
              <p-sortIcon field="estado" />
            </div>
          </th>
          <th pSortableColumn="total" class="th-total">
            <div class="th-content">
              <i class="fas fa-dollar-sign"></i>
              <span>Total</span>
              <p-sortIcon field="total" />
            </div>
          </th>
          <th class="th-actions">
            <div class="th-content">
              <i class="fas fa-cog"></i>
              <span>Acciones</span>
            </div>
          </th>
        </tr>
      </ng-template>

      <!-- Table Body -->
      <ng-template pTemplate="body" let-budget>
        <tr class="table-body-row">
          <!-- Codigo -->
          <td class="td-code">
            <span class="code-badge">{{ budget.internalCode }}</span>
          </td>
          
          <!-- Fecha -->
          <td class="td-date">
            <span class="date-text">{{ budget.date | date: 'dd MMM yyyy' }}</span>
          </td>
          
          <!-- Obra -->
          <td class="td-name">
            <div class="name-wrapper">
              <span class="budget-name">{{ budget.budgetName | capitalize | truncate:50 }}</span>
              <span *ngIf="budget.isInvoice" class="invoice-indicator" pTooltip="Facturada" tooltipPosition="top">
                <i class="fas fa-receipt"></i>
              </span>
            </div>
          </td>
          
          <!-- Cliente -->
          <td class="td-customer">
            <span class="customer-name">{{ budget.customerDto.customerName | capitalize | truncate:30 }}</span>
          </td>
          
          <!-- Factura -->
          <td class="td-invoice">
            <span 
              *ngIf="editingInvoiceBudgetId !== budget.budgetId" 
              (click)="startEditingInvoice(budget)" 
              class="invoice-value"
              [class.has-invoice]="budget.externalInvoice && budget.externalInvoice !== '0'"
              pTooltip="Clic para editar"
              tooltipPosition="top">
              <c-badge *ngIf="budget.externalInvoice && budget.externalInvoice !== '0'" color="success">
                {{ budget.externalInvoice }}
              </c-badge>
              <span *ngIf="!budget.externalInvoice || budget.externalInvoice === '0'" class="no-invoice">
                <i class="far fa-file"></i> Sin factura
              </span>
            </span>
            <div *ngIf="editingInvoiceBudgetId === budget.budgetId" class="invoice-edit-wrapper">
              <input 
                pInputText 
                [(ngModel)]="editingInvoiceValue" 
                (blur)="saveExternalInvoice(budget)"
                (keyup.enter)="saveExternalInvoice(budget)"
                (keyup.escape)="cancelEditingInvoice()"
                class="invoice-input"
                placeholder="Factura"
                #invoiceInput>
            </div>
          </td>
          
          <!-- Estado -->
          <td class="td-status">
            <p-dropdown 
              [options]="statusOptions" 
              [(ngModel)]="budget.estado" 
              (onChange)="onStatusChange(budget)" 
              appendTo="body"
              styleClass="status-dropdown"
              optionLabel="label" 
              optionValue="value">
              <ng-template pTemplate="selectedItem">
                <div class="status-badge-wrapper">
                  <span 
                    *ngIf="budget.estado" 
                    class="status-badge"
                    [ngClass]="getStatusClass(budget.estado)">
                    <i [class]="getStatusIcon(budget.estado)"></i>
                    {{ budget.estado }}
                  </span>
                </div>
              </ng-template>
              <ng-template let-option pTemplate="item">
                <span 
                  class="status-badge status-option"
                  [ngClass]="getStatusClass(option.value)">
                  <i [class]="getStatusIcon(option.value)"></i>
                  {{ option.label }}
                </span>
              </ng-template>
            </p-dropdown>
          </td>
          
          <!-- Total -->
          <td class="td-total">
            <span class="total-value">
              $ {{ budget.total.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) }}
            </span>
          </td>
          
          <!-- Acciones -->
          <td class="td-actions">
            <div class="action-buttons">
              <button 
                class="action-btn action-edit" 
                [routerLink]="['/budgets/update', budget.budgetId]" 
                pTooltip="Editar" 
                tooltipPosition="top">
                <i class="fas fa-pen"></i>
              </button>
              <button 
                class="action-btn action-pdf" 
                (click)="downloadBudget(budget)" 
                pTooltip="Descargar PDF" 
                tooltipPosition="top">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button 
                class="action-btn action-excel" 
                (click)="downloadExcel(budget)" 
                pTooltip="Descargar Excel" 
                tooltipPosition="top">
                <i class="fas fa-file-excel"></i>
              </button>
              <button 
                class="action-btn action-copy" 
                (click)="copybudget(budget)" 
                pTooltip="Duplicar" 
                tooltipPosition="top">
                <i class="fas fa-copy"></i>
              </button>
              <button 
                class="action-btn action-more" 
                (click)="onMenuClick($event, budget)" 
                pTooltip="Mas opciones" 
                tooltipPosition="top">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="empty-state">
            <div class="empty-content">
              <i class="fas fa-folder-open empty-icon"></i>
              <h3>No hay cotizaciones</h3>
              <p>No se encontraron cotizaciones que coincidan con tu busqueda</p>
              <a [routerLink]="'/budgets/add'" class="btn-create-first">
                <i class="fas fa-plus"></i>
                Crear primera cotizacion
              </a>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Context Menu -->
    <p-menu #menu [model]="menuItems" [popup]="true" appendTo="body"></p-menu>
  </div>
</div>

<!-- Modal de confirmacion -->
<app-confirmation-modal 
  #confirmationModal  
  [messageModal]="messageModal"
  [title]="title"
  [isModalError]="isModalError"
  [alignment]="'top'">
</app-confirmation-modal>

<!-- Dialog para parametros del cronograma -->
<p-dialog 
  [(visible)]="displayScheduleDialog" 
  [header]="'Descargar Cronograma'" 
  [modal]="true" 
  [style]="{width: '450px'}"
  [draggable]="false"
  [resizable]="false"
  styleClass="modern-dialog">
  <div class="p-fluid dialog-content">
    <div class="form-group-modern">
      <label class="label-modern">
        <i class="fas fa-calendar-week"></i>
        Numero de Semanas
      </label>
      <p-inputNumber 
        id="weeks" 
        [(ngModel)]="scheduleParams.weeks" 
        [min]="1" 
        [max]="52"
        [showButtons]="true"
        styleClass="input-modern">
      </p-inputNumber>
    </div>
    <div class="form-group-modern mt-3">
      <label class="label-modern">
        <i class="far fa-calendar-alt"></i>
        Fecha de Inicio
      </label>
      <p-calendar 
        id="startDate" 
        [(ngModel)]="scheduleParams.startDate" 
        dateFormat="yy-mm-dd"
        [showIcon]="true"
        styleClass="input-modern">
      </p-calendar>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button 
        class="btn-dialog btn-cancel" 
        (click)="displayScheduleDialog = false">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button 
        class="btn-dialog btn-confirm" 
        (click)="downloadSchedule()" 
        [disabled]="!scheduleParams.weeks || !scheduleParams.startDate">
        <i class="fas fa-download"></i>
        Descargar
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog para unir cotizaciones -->
<p-dialog 
  [(visible)]="displayMergeDialog" 
  [header]="'Unir Cotizaciones'" 
  [modal]="true" 
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false"
  styleClass="modern-dialog">
  <div class="p-fluid dialog-content">
    <div class="form-group-modern">
      <label class="label-modern">
        <i class="fas fa-file-alt"></i>
        Primera Cotizacion (seleccionada)
      </label>
      <input 
        pInputText 
        [value]="getSelectedBudgetLabel()"
        [disabled]="true"
        class="input-modern disabled">
    </div>
    <div class="form-group-modern mt-3">
      <label class="label-modern">
        <i class="fas fa-file-alt"></i>
        Segunda Cotizacion <span class="required-star">*</span>
      </label>
      <p-dropdown 
        [options]="getAvailableBudgetsForMerge()" 
        [(ngModel)]="mergeParams.budgetId2" 
        optionLabel="internalCode" 
        optionValue="budgetId"
        placeholder="Selecciona una cotizacion"
        [filter]="true"
        filterBy="internalCode,budgetName"
        appendTo="body"
        [showClear]="true"
        styleClass="dropdown-modern">
        <ng-template let-budget pTemplate="item">
          <div class="dropdown-item-content">
            <span class="dropdown-code">{{ budget.internalCode }}</span>
            <span class="dropdown-name">{{ budget.budgetName | truncate:40 }}</span>
          </div>
        </ng-template>
      </p-dropdown>
    </div>
    <div class="form-group-modern mt-3">
      <label class="label-modern">
        <i class="fas fa-tag"></i>
        Nombre de la Nueva Cotizacion <span class="required-star">*</span>
      </label>
      <input 
        pInputText 
        [(ngModel)]="mergeParams.newBudgetName" 
        placeholder="Ingresa el nombre"
        class="input-modern">
    </div>
    <div class="form-group-modern mt-3">
      <label class="label-modern">
        <i class="fas fa-sticky-note"></i>
        Nota (opcional)
      </label>
      <textarea 
        pInputTextarea 
        [(ngModel)]="mergeParams.note" 
        rows="3" 
        placeholder="Agrega una nota sobre la union"
        class="textarea-modern">
      </textarea>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <button 
        class="btn-dialog btn-cancel" 
        (click)="displayMergeDialog = false">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button 
        class="btn-dialog btn-confirm" 
        (click)="mergeBudgets()" 
        [disabled]="!mergeParams.budgetId1 || !mergeParams.budgetId2 || !mergeParams.newBudgetName">
        <i class="fas fa-plus-circle"></i>
        Unir Cotizaciones
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de seleccion de emails -->
<app-email-selector-modal 
  #emailSelectorModal
  [emails]="availableEmails"
  (confirmAction)="onEmailsSelected($event)">
</app-email-selector-modal>

<ngx-spinner 
  bdColor="rgba(0, 0, 0, 0.8)" 
  size="medium" 
  color="#fff" 
  type="square-jelly-box" 
  [fullScreen]="true">
  <p style="color: white">Cargando...</p>
</ngx-spinner>
