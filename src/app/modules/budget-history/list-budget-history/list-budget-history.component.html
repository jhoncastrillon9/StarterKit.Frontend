<!-- Container Principal Moderno -->
<div class="history-list-container">
  <!-- Header Principal Moderno -->
  <div class="history-list-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">
          <i class="fas fa-history"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">Historial de Cotizaciones</h1>
          <p class="page-subtitle">Consulta y restaura versiones anteriores</p>
        </div>
      </div>
      <div class="header-right">
        <div class="header-stats">
          <div class="stat-badge">
            <i class="fas fa-database"></i>
            <span>{{ totalRecords }} registros</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros Card -->
  <div class="filters-card">
    <div class="filters-header">
      <i class="fas fa-filter"></i>
      <span>Filtros de Busqueda</span>
    </div>
    <div class="filters-body">
      <div class="filters-grid">
        <!-- Codigo Interno -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-hashtag"></i>
            Codigo Interno
          </label>
          <input 
            type="number" 
            class="filter-input"
            [(ngModel)]="internalCodeFilter"
            placeholder="Ej: 1234"
          />
        </div>

        <!-- Log de Cambio -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-clipboard-list"></i>
            Descripcion del Cambio
          </label>
          <input 
            type="text" 
            class="filter-input"
            [(ngModel)]="logCambioFilter"
            placeholder="Buscar en log de cambios..."
          />
        </div>

        <!-- Fecha Desde -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="far fa-calendar-alt"></i>
            Desde
          </label>
          <input 
            type="date" 
            class="filter-input"
            [(ngModel)]="fromDateFilter"
          />
        </div>

        <!-- Fecha Hasta -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="far fa-calendar-alt"></i>
            Hasta
          </label>
          <input 
            type="date" 
            class="filter-input"
            [(ngModel)]="toDateFilter"
          />
        </div>
      </div>

      <!-- Botones de Filtro -->
      <div class="filter-actions">
        <button 
          class="btn-filter btn-search" 
          (click)="applyFilters()"
          [disabled]="loading">
          <i class="fas fa-search"></i>
          <span>Buscar</span>
        </button>
        <button 
          class="btn-filter btn-clear" 
          (click)="clear(dt)"
          [disabled]="loading">
          <i class="fas fa-eraser"></i>
          <span>Limpiar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="history-list-card">
    <!-- Table Container -->
    <p-table 
      #dt
      class="history-table-modern"
      styleClass="p-datatable-modern"
      [value]="historyItems" 
      [paginator]="true" 
      [rows]="filterRequest.pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="loadHistory($event)"
      [loading]="loading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      [rowsPerPageOptions]="[10, 25, 50, 100]"
      [tableStyle]="{ 'min-width': '50rem' }"
      [globalFilterFields]="['budgetName', 'internalCode', 'estado', 'logCambio']"
      [rowHover]="true">

      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr class="table-header-row">
          <th class="th-code">
            <div class="th-content">
              <i class="fas fa-hashtag"></i>
              <span>Codigo</span>
            </div>
          </th>
          <th class="th-date">
            <div class="th-content">
              <i class="far fa-calendar-alt"></i>
              <span>Fecha</span>
            </div>
          </th>
          <th class="th-name">
            <div class="th-content">
              <i class="fas fa-building"></i>
              <span>Obra</span>
            </div>
          </th>
          <th class="th-log">
            <div class="th-content">
              <i class="fas fa-clipboard-list"></i>
              <span>Log de Cambio</span>
            </div>
          </th>
          <th class="th-actions">
            <div class="th-content">
              <i class="fas fa-cog"></i>
              <span>Acciones</span>
            </div>
          </th>
        </tr>
      </ng-template>

      <!-- Table Body -->
      <ng-template pTemplate="body" let-history>
        <tr class="table-body-row">
          <!-- Codigo -->
          <td class="td-code">
            <span class="code-badge">{{ history.internalCode }}</span>
          </td>
          
          <!-- Fecha -->
          <td class="td-date">
            <div class="date-wrapper">
              <span class="date-text">{{ history.fecha | date: 'dd MMM yyyy' }}</span>
              <span class="time-text">{{ history.fecha | date: 'HH:mm' }}</span>
            </div>
          </td>
          
          <!-- Obra -->
          <td class="td-name">
            <span class="budget-name">{{ history.budgetName }}</span>
          </td>
          
          <!-- Log de Cambio -->
          <td class="td-log">
            <div class="log-wrapper">
              <i class="fas fa-info-circle log-icon"></i>
              <span class="log-text">{{ history.logCambio }}</span>
            </div>
          </td>
          
          <!-- Acciones -->
          <td class="td-actions">
            <div class="action-buttons">
              <button 
                class="action-btn action-view" 
                (click)="viewBudget(history)"
                pTooltip="Ver/Descargar PDF" 
                tooltipPosition="top">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button 
                class="action-btn action-restore" 
                (click)="restoreBudgetWithConfirm(history)"
                pTooltip="Restaurar cotizacion" 
                tooltipPosition="top">
                <i class="fas fa-undo-alt"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty Message -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="empty-state">
            <div class="empty-content">
              <i class="fas fa-history empty-icon"></i>
              <h3>No hay registros</h3>
              <p>No se encontraron registros en el historial con los filtros aplicados</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Modal de confirmacion -->
<app-confirmation-modal #confirmationModal></app-confirmation-modal>

<ngx-spinner 
  bdColor="rgba(0, 0, 0, 0.8)" 
  size="medium" 
  color="#fff" 
  type="square-jelly-box" 
  [fullScreen]="true">
  <p style="color: white">Cargando...</p>
</ngx-spinner>
